<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>my page</title>
    <meta name="description" content="ç€ç‰©æ—¥è¨˜" />
    <meta property="og:title" content="ç€ç‰©æ—¥è¨˜" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="#" />
    <meta property="og:site_name" content="ç€ç‰©æ—¥è¨˜" />
    <meta property="og:description" content="ç€ç‰©æ—¥è¨˜" />
    <meta name="format-detection" content="telephone=no" />
    <link rel="canonical" href="#" />
    <link rel="stylesheet" type="text/css" href="css/reset.css" />
    <link rel="stylesheet" type="text/css" href="css/sanitize.css" />
    <link
      href="https://fonts.googleapis.com/earlyaccess/kokoro.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="css/style.css" />
  </head>

  <body>
    <div>
      <!--æŠ•ç¨¿è€…-->
      <div>åå‰ï¼š<input type="text" id="name" /></div>
      <!--ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰-->
      <div><input type="file" id="picture" /></div>
      <!--ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›-->
      <div>
        <textarea rows="5" id="text"></textarea>
      </div>
      <!--é€ä¿¡ãƒœã‚¿ãƒ³-->
      <div>
        <button type="button" id="send">é€ä¿¡</button>
      </div>
      <!--é€ä¿¡çµæœã‚’ãƒªã‚¹ãƒˆè¡¨ç¤º-->
      <div id="output"></div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
      // æ—¥æ™‚ã‚’ã„ã„æ„Ÿã˜ã®å½¢å¼ã«ã™ã‚‹é–¢æ•° è‡ªåˆ†ã§ä½œã‚‹æ™‚ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰æŒã£ã¦ããŸã»ã†ãŒã„ã„
      function convertTimestampToDatetime(timestamp) {
        const _d = timestamp ? new Date(timestamp * 1000) : new Date();
        const Y = _d.getFullYear();
        const m = (_d.getMonth() + 1).toString().padStart(2, "0");
        const d = _d.getDate().toString().padStart(2, "0");
        const H = _d.getHours().toString().padStart(2, "0");
        const i = _d.getMinutes().toString().padStart(2, "0");
        const s = _d.getSeconds().toString().padStart(2, "0");
        return `${Y}/${m}/${d} ${H}:${i}:${s}`;
      }
    </script>
    <!-- ä»¥ä¸‹ã«firebaseã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã‚ˆã† -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
      import {} from "https://www.gstatic.com/firebasejs/9.21.0/firebase-storage.js";
      // ğŸ”½ è¿½åŠ  / `9.2.0`ã®éƒ¨åˆ†ã‚’â†‘ã®Firestoreã‹ã‚‰è²¼ã‚Šä»˜ã‘ãŸã‚³ãƒ¼ãƒ‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åˆã‚ã›ã‚‹
      import {
        getFirestore,
        collection,
        addDoc, //ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
        serverTimestamp,
        query, //æ‰‹å‹•ã§è¿½åŠ 
        orderBy, //æ‰‹å‹•ã§è¿½åŠ  æ¡ä»¶ã®æŒ‡å®š
        onSnapshot, //æ‰‹å‹•ã§è¿½åŠ  ä¸¦ã³æ›¿ãˆ
      } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
        listAll,
      } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCxMMO4AxGFLJXLyx8EwLiBoPd-hzscOP4",
        authDomain: "kimono-1-4f3bc.firebaseapp.com",
        projectId: "kimono-1-4f3bc",
        storageBucket: "kimono-1-4f3bc.appspot.com",
        messagingSenderId: "379765797470",
        appId: "1:379765797470:web:5c11f8d53b3c6c0385facf",
      };

      //firebaseã‚¬ã‚¤ãƒ‰ã‹ã‚‰å¼•ç”¨
      const app = initializeApp(firebaseConfig);
      const storage = getStorage(app);
      const db = getFirestore(app);

      //é€ä¿¡å‡¦ç†
      $("#send").on("click", function () {
        const fileInput = document.getElementById("picture");
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const spaceRef = ref(storage, `${file.name}`);
          uploadBytes(spaceRef, file).then((snapshot) => {
            console.log("Uploaded a blob or file!");
            getDownloadURL(spaceRef).then((url) => {
              console.log(url);
            });
          });
        }

        const postData = {
          name: $("#name").val(),
          text: $("#text").val(),
          time: serverTimestamp(),
        };
        addDoc(collection(db, "post"), postData);
        $("#name").val("");
        $("#picture").val("");
        $("#text").val("");
        console.log(file);
      });

      // ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã™æ¡ä»¶
      const q = query(collection(db, "post"), orderBy("time", "desc"));

      onSnapshot(q, async (querySnapshot) => {
        // ã“ã“ã‹ã‚‰ä¸‹ã¯æ¯å›åŒã˜å‡¦ç†
        console.log(querySnapshot.docs);
        const documents = [];
        querySnapshot.docs.forEach(function (doc) {
          const document = {
            id: doc.id,
            data: doc.data(),
          };
          documents.push(document);
          console.log(document.data);
        });

        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function getImageUrlFromStorage(fileName) {
          const spaceRef = ref(storage, fileName); // ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’æŒ‡å®š
          const url = await getDownloadURL(spaceRef);
          console.log(url);
          return url;
        }

        // ç¢ºèªç”¨
        console.log(documents);

        //ã‚¿ã‚°ã‚’ç”»é¢ã«è¡¨ç¤º è‡ªåˆ†ã§å®šç¾©
        const htmlElements = [];
        for (const document of documents) {
          const timestamp = document.data.time;
          const fileName = document.data.fileName;
          const timeStr = timestamp
            ? convertTimestampToDatetime(timestamp.seconds)
            : "";
          const url = await getImageUrlFromStorage(fileName);
          const imageElement = `<img src="${url}" alt="image"/>`;
          htmlElements.push(`
        <li id="${document.id}">
          <p>${document.data.name}</p>
          <p>${timeStr}</p>
          ${imageElement}
          <p>${document.data.text}</p>
        </li>
      `);
        }
        $("#output").html(htmlElements);
      });
    </script>
  </body>
</html>
