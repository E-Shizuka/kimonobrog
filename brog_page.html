<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>my page</title>
    <meta name="description" content="着物日記" />
    <meta property="og:title" content="着物日記" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="#" />
    <meta property="og:site_name" content="着物日記" />
    <meta property="og:description" content="着物日記" />
    <meta name="format-detection" content="telephone=no" />
    <link rel="canonical" href="#" />
    <link rel="stylesheet" type="text/css" href="css/reset.css" />
    <link rel="stylesheet" type="text/css" href="css/sanitize.css" />
    <link
      href="https://fonts.googleapis.com/earlyaccess/kokoro.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="css/style.css" />
  </head>

  <body>
    <div>
      <!--投稿者-->
      <div>名前：<input type="text" id="name" /></div>
      <!--画像アップロード-->
      <div><input type="file" id="picture" /></div>
      <!--テキスト入力-->
      <div>
        <textarea rows="5" id="text"></textarea>
      </div>
      <!--送信ボタン-->
      <div>
        <button type="button" id="send">送信</button>
      </div>
      <!--送信結果をリスト表示-->
      <div id="output"></div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
      // 日時をいい感じの形式にする関数 自分で作る時はライブラリから持ってきたほうがいい
      function convertTimestampToDatetime(timestamp) {
        const _d = timestamp ? new Date(timestamp * 1000) : new Date();
        const Y = _d.getFullYear();
        const m = (_d.getMonth() + 1).toString().padStart(2, "0");
        const d = _d.getDate().toString().padStart(2, "0");
        const H = _d.getHours().toString().padStart(2, "0");
        const i = _d.getMinutes().toString().padStart(2, "0");
        const s = _d.getSeconds().toString().padStart(2, "0");
        return `${Y}/${m}/${d} ${H}:${i}:${s}`;
      }
    </script>
    <!-- 以下にfirebaseのコードを貼り付けよう -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
      import {} from "https://www.gstatic.com/firebasejs/9.21.0/firebase-storage.js";
      // 🔽 追加 / `9.2.0`の部分を↑のFirestoreから貼り付けたコードのバージョンに合わせる
      import {
        getFirestore,
        collection,
        addDoc, //ドキュメントを追加
        serverTimestamp,
        query, //手動で追加
        orderBy, //手動で追加 条件の指定
        onSnapshot, //手動で追加 並び替え
      } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
        listAll,
      } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCxMMO4AxGFLJXLyx8EwLiBoPd-hzscOP4",
        authDomain: "kimono-1-4f3bc.firebaseapp.com",
        projectId: "kimono-1-4f3bc",
        storageBucket: "kimono-1-4f3bc.appspot.com",
        messagingSenderId: "379765797470",
        appId: "1:379765797470:web:5c11f8d53b3c6c0385facf",
      };

      //firebaseガイドから引用
      const app = initializeApp(firebaseConfig);
      const storage = getStorage(app);
      const db = getFirestore(app);

      //送信処理
      $("#send").on("click", function () {
        const fileInput = document.getElementById("picture");
        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const spaceRef = ref(storage, `${file.name}`);
          uploadBytes(spaceRef, file).then((snapshot) => {
            console.log("Uploaded a blob or file!");
            getDownloadURL(spaceRef).then((url) => {
              console.log(url);
            });
          });
        }

        const postData = {
          name: $("#name").val(),
          text: $("#text").val(),
          time: serverTimestamp(),
        };
        addDoc(collection(db, "post"), postData);
        $("#name").val("");
        $("#picture").val("");
        $("#text").val("");
        console.log(file);
      });

      // データを取り出す条件
      const q = query(collection(db, "post"), orderBy("time", "desc"));

      onSnapshot(q, async (querySnapshot) => {
        // ここから下は毎回同じ処理
        console.log(querySnapshot.docs);
        const documents = [];
        querySnapshot.docs.forEach(function (doc) {
          const document = {
            id: doc.id,
            data: doc.data(),
          };
          documents.push(document);
          console.log(document.data);
        });

        // ストレージから画像のダウンロードURLを取得する関数
        async function getImageUrlFromStorage(fileName) {
          const spaceRef = ref(storage, fileName); // ファイルのパスを指定
          const url = await getDownloadURL(spaceRef);
          console.log(url);
          return url;
        }

        // 確認用
        console.log(documents);

        //タグを画面に表示 自分で定義
        const htmlElements = [];
        for (const document of documents) {
          const timestamp = document.data.time;
          const fileName = document.data.fileName;
          const timeStr = timestamp
            ? convertTimestampToDatetime(timestamp.seconds)
            : "";
          const url = await getImageUrlFromStorage(fileName);
          const imageElement = `<img src="${url}" alt="image"/>`;
          htmlElements.push(`
        <li id="${document.id}">
          <p>${document.data.name}</p>
          <p>${timeStr}</p>
          ${imageElement}
          <p>${document.data.text}</p>
        </li>
      `);
        }
        $("#output").html(htmlElements);
      });
    </script>
  </body>
</html>
